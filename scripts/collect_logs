#!/bin/sh
# referenced from https://github.com/tatsuru/isucon13/blob/main/scripts/deploy

now=$(date +%Y%m%d-%H%M%S)
REMOTE_USER="isucon"
REMOTE_HOST="54.95.112.73"
ACCESS_LOG="/var/log/nginx/access.log"
SLOW_QUERY_LOG="/var/log/mysql/mysql-slow.log"

mv ./logs/access.log ./logs/access.$now.log
mv ./logs/mysql-slow.log ./logs/mysql-slow.$now.log

ssh ${REMOTE_USER}@${REMOTE_HOST} "sudo cp ${SLOW_QUERY_LOG} /tmp/mysql-slow.log && sudo chmod 644 /tmp/mysql-slow.log"
scp ${REMOTE_USER}@${REMOTE_HOST}:/tmp/mysql-slow.log ./logs/mysql-slow.log
ssh ${REMOTE_USER}@${REMOTE_HOST} "sudo rm /tmp/mysql-slow.log"

ssh ${REMOTE_USER}@${REMOTE_HOST} "sudo cp ${ACCESS_LOG} /tmp/access.log && sudo chmod 644 /tmp/access.log"
scp ${REMOTE_USER}@${REMOTE_HOST}:/tmp/access.log ./logs/access.log
ssh ${REMOTE_USER}@${REMOTE_HOST} "sudo rm /tmp/access.log"
